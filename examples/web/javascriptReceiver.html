<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bionic Glove JavaScript Receiver</title>
    <style>
        .bar-chart {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 200px;
            width: 400px;
            border: 1px solid #ccc;
            margin-top: 20px;
            padding: 5px;
        }

        .bar {
            width: 25%;
            background-color: #007bff;
        }
    </style>
</head>
<button id="requestPortButton">Request Serial Port</button>

<body>
    <div class="bar-chart" id="chart">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
    </div>

    <script>
        const requestPortButton = document.getElementById("requestPortButton");
        // Add a click event listener to the button
        requestPortButton.addEventListener("click", async () => {
            try {
                callSerialBT();
            } catch (error) {
                console.error("Error requesting serial port:", error);
            }
        });

        function updateBars(data) {
            const bars = document.querySelectorAll('.bar');
            const dataPack = data.split(',');
            const values = dataPack.slice(0, 4); // get only first 4 tokens
            const maxDataValue = 511; //max token value
            values.forEach((value, index) => {
                const height = (parseInt(value) / maxDataValue) * 100;
                bars[index].style.height = height + '%';
            });
        }

        async function callSerialBT() {
            const port = await navigator.serial.requestPort();
            await port.open({ baudRate: 38400 });
            const reader = port.readable.getReader();
            let dataPack = ''; //stores splitted buffer
            let readComplete = false; // flag to finish reading 
            try {
                while (true) {
                    //move all available buffer bytes to 'value'
                    const { btBuffer, done } = await reader.read();
                    if (done) { //finish read buffer
                        readComplete = true;
                        break;
                    }
                    const decoder = new TextDecoder();
                    const stringValue = decoder.decode(btBuffer); //char to string
                    var dataString = stringValue;
                    var startIndex = dataString.indexOf('s', startIndex);
                    var endIndex = dataString.indexOf('e', startIndex + 1);
                    while (dataString.includes('*') && (endIndex >= 0)) { //recognize ALL datapacks inside the buffer
                        //if (dataString.includes('*')) {                 //recognize only first datapack
                        const trimmedData = dataString.substring(startIndex + 1, endIndex);
                        dataPack = trimmedData.split(',');
                        if (dataPack.length == 14) {
                            //console.log(dataPack);
                            updateBars(trimmedData);
                        }
                        dataString = dataString.substring(endIndex + 2, dataString.length); //shrink dataString
                        startIndex = dataString.indexOf('s', startIndex);
                        endIndex = dataString.indexOf('e', startIndex + 1);
                    }
                }
            } catch (error) {
                console.error(error);
            } finally {
                // Verifica se a leitura foi conclu√≠da antes de fechar a porta serial
                if (readComplete) {
                    reader.releaseLock(); // Libera o leitor antes de fechar a porta
                    await port.close(); // Fecha a porta serial ao final do processamento
                }

            }

        }
    </script>

</body>

</html>