<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receber Dados da Porta Serial</title>
    <style>
        .bar-chart {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 200px;
            width: 400px;
            border: 1px solid #ccc;
            margin-top: 20px;
            padding: 5px;
        }

        .bar {
            width: 25%;
            background-color: #007bff;
        }
    </style>
</head>
<button id="requestPortButton">Request Serial Port</button>

<body>
    <div class="bar-chart" id="chart">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
    </div>

    <script>
        // Função para atualizar as alturas das barras
        function updateBars(data) {
            const bars = document.querySelectorAll('.bar');

            // Separar os dados por vírgula
            const dataArray = data.split(',');

            // Obter os quatro primeiros valores
            const values = dataArray.slice(0, 4);

            // Calcular a altura das barras
            const maxDataValue = 4095; // Valor máximo dos dados recebidos
            values.forEach((value, index) => {
                const height = (parseInt(value) / maxDataValue) * 100;
                bars[index].style.height = height + '%';
            });
        }
    </script>

    <script>
        const requestPortButton = document.getElementById("requestPortButton");

        // Add a click event listener to the button
        requestPortButton.addEventListener("click", async () => {
            try {
                callBionic();
            } catch (error) {
                console.error("Error requesting serial port:", error);
            }
        });
    </script>

    <script>

        async function callBionic() {
            const port = await navigator.serial.requestPort();
            await port.open({ baudRate: 38400 });

            const reader = port.readable.getReader();
            let receivedData = ''; // Variável para acumular os dados recebidos
            let readComplete = false; // Variável de controle para indicar que a leitura foi concluída

            try {
                var i = 0;
                let dataArray = '';

                while (true) {
                    //armazena em 'value' todo o lote de bytes disponiveis no buffer
                    const { value, done } = await reader.read();
                    if (done) { //se terminou de ler todo o buffer
                        readComplete = true;
                        break;
                    }
                    const decoder = new TextDecoder();
                    const stringValue = decoder.decode(value);
                    receivedData += stringValue;
                    if (receivedData.includes('e')) {
                        // Fazendo o "trim" com início no caractere 's' e fim no caractere 'e'
                        const startIndex = receivedData.indexOf('s');
                        const endIndex = receivedData.indexOf('e');
                        const trimmedData = receivedData.substring(startIndex + 1, endIndex);
                        dataArray = trimmedData.split(',');
                        console.log(dataArray); // Array com os dados separados por vírgula
                        // Limpa a variável receivedData para futuras leituras
                        receivedData = '';
                        //console.log(dataArray);
                        updateBars(trimmedData);
                    }
                }
            } catch (error) {
                console.error(error);
            } finally {
                // Verifica se a leitura foi concluída antes de fechar a porta serial
                if (readComplete) {
                    reader.releaseLock(); // Libera o leitor antes de fechar a porta
                    await port.close(); // Fecha a porta serial ao final do processamento
                }

            }

        }
    </script>

</body>

</html>